---
title: "Data Gathering"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(janitor)
library(tidycensus)
library(leaflet)
library(lubridate)
library(stringr)
library(rstanarm)
library(naniar)
library(tidymodels)
library(ggthemes)
```

Dataset
```{r}
acled_data <- read_xlsx("raw_data/protest_data.xlsx") %>%
  clean_names() %>%
  mutate(assoc_actor_1 = as.factor(assoc_actor_1),
         event_type = as.factor(event_type),
         sub_event_type = as.factor(sub_event_type)) %>%
  filter(!event_type == "Strategic developments") %>%
  mutate(event_date = ymd(event_date))

acled_data_new <- acled_data %>%
  select(-c(iso, event_id_cnty, event_id_no_cnty, year, time_precision, region, 
            country, admin3, geo_precision, source_scale, source, inter1,
            inter2, interaction)) %>%
  mutate(assoc_actor_1 = as.character(assoc_actor_1)) %>%
  rename("district" = admin2) %>%
  transform("district" = paste(district, admin1, sep = ", "))
```

Prepping ACLED data for violence modeling
```{r}
acled_modeling <- acled_data_new %>%
  mutate(violence = ifelse(sub_event_type == "Peaceful protest", 
                           yes = FALSE, no = TRUE))

count_violent <- acled_modeling %>%
  filter(violence == TRUE) %>%  
  group_by(district) %>%
  summarize(number_violent = n(), .groups = "drop")

count_protests <- acled_modeling %>%
  group_by(district) %>%
  summarize(number_protests = n(), .groups = "drop")

model_violence <- full_join(count_violent, count_protests, by = "district") %>%
  mutate(number_violent = as.numeric(number_violent),
         number_protests = as.numeric(number_protests))

model_violence[is.na(model_violence)] <- 0
  
model_violence <- model_violence %>%
  mutate(proportion_violent = number_violent / number_protests,
         violence = ifelse(proportion_violent == 0,
                                      yes = FALSE,
                                      no = TRUE)) %>%
  select(!violence) %>%
  mutate(district = tolower(district))
```

Function for inputting new parameters from Census data
```{r}
census_formatting <- function(ds){
  ds_clean <- ds %>%
    separate(col = district, sep = ", ", into = c("district", "state")) %>%
    mutate(problem = ifelse(district %in% c("Baltimore city",
                                        "St. Louis city",
                                        "Roanoke city"), 
                            yes = TRUE, no = FALSE))
  
  ds_clean %>%
    mutate(district = ifelse(problem == FALSE, yes = sub(ds_clean$district, 
                                                         pattern = " [[:alpha:]]*$", 
                                                         replacement = ""),
                           no = ds_clean$district)) %>%
    transform(district = paste(district, state, sep = ", ")) %>%
    select(!c(state, problem))
}

duplication <- function(ds){
  ds %>%
    mutate("duplicated" = duplicated(ds$district)) %>%
    filter(duplicated == TRUE)
}
```

Reading in parameters
```{r}
# gini
gini <- read_csv("raw_data/census_gini.csv", skip = 1, col_types = cols(
  .default = col_character()
)) %>%
  clean_names() %>%
  rename("district" = geographic_area_name, 
         "gini_score" = estimate_gini_index) %>%
  select(district, gini_score) %>%
  census_formatting() %>%
  mutate(gini_score = as.numeric(gini_score))

# poverty
poverty <- read_csv("raw_data/census_poverty.csv", skip = 1, col_types = cols(
  .default = col_character()
)) %>%
  clean_names() %>%
  select(estimate_percent_below_poverty_level_population_for_whom_poverty_status_is_determined,
         geographic_area_name) %>%
  rename("poverty" = estimate_percent_below_poverty_level_population_for_whom_poverty_status_is_determined,
         "district" = geographic_area_name) %>%
  mutate(poverty = as.numeric(poverty)) %>%
  census_formatting()

# income
income <- read_csv("raw_data/census_income.csv", skip = 1, col_types = cols(
  .default = col_character()
)) %>%
  clean_names() %>%
  select(geographic_area_name, estimate_households_median_income_dollars) %>%
  rename("income" = estimate_households_median_income_dollars,
         "district" = geographic_area_name) %>%
  mutate(income = as.numeric(income)) %>%
  census_formatting()

# population
population <- read_csv("raw_data/census_population.csv", skip = 1, 
                       col_types = cols(
  .default = col_character()
)) %>%
  clean_names() %>%
  select(geographic_area_name, estimate_total) %>%
  rename("population" = estimate_total,
         "district" = geographic_area_name) %>%
  mutate(population = as.numeric(population)) %>%
  census_formatting()

# unemployment
unemployment <- read_csv("raw_data/census_unemployment.csv", skip = 1, 
                         col_types = cols(
  .default = col_character()
)) %>%
  clean_names() %>%
  select(estimate_unemployment_rate_population_16_years_and_over, geographic_area_name,
         estimate_total_educational_attainment_population_25_to_64_years_less_than_high_school_graduate,
         estimate_total_educational_attainment_population_25_to_64_years) %>%
  rename("unemployment" = estimate_unemployment_rate_population_16_years_and_over,
         "less_than_hs" = estimate_total_educational_attainment_population_25_to_64_years_less_than_high_school_graduate,
         "edu_pop" = estimate_total_educational_attainment_population_25_to_64_years,
         "district" = geographic_area_name) %>%
  mutate("unemployment" = as.numeric(unemployment),
         "less_than_hs" = as.numeric(less_than_hs),
         "edu_pop" = as.numeric(edu_pop)) %>%
  census_formatting()

# education
education <- unemployment %>%
  mutate(percent_less_than_hs = (less_than_hs/edu_pop)*100) %>%
  select(percent_less_than_hs, district)

# all census data
census_data <- inner_join(education, gini, by = "district") %>%
  inner_join(income, by = "district") %>%
  inner_join(population, by = "district") %>%
  inner_join(poverty, by = "district") %>%
  inner_join(unemployment, by = "district") %>%
  mutate(district = tolower(district))
```

Police Killings Data
```{r}
# police killings
states <- tibble(state_name = state.name) %>%
  bind_cols(tibble(state = state.abb))

police_killings <- read_excel("raw_data/police_killings.xlsx") %>%
  left_join(states, by = "state") %>%
  select(!state) %>%
  rename("state" = state_name,
         "district" = county) %>%
  drop_na() %>%
  transform(district = paste(district, state, sep=", ")) %>%
  group_by(district) %>%
  summarize(police_killings = n(), .groups = "drop") %>%
  mutate(district = tolower(district))
```

County Health Data
```{r}
health_1 <- read_excel("raw_data/ranked_measure_data.xlsx", 
                                  skip = 1) %>%
  clean_names() %>%
  drop_na(county) %>%
  transform(district = paste(county, state, sep = ", ")) %>%
  rename("premature_death_rate" = years_of_potential_life_lost_rate,
         "housing_problems" = percent_severe_housing_problems) %>%
  select(district, premature_death_rate, teen_birth_rate, 
         preventable_hospitalization_rate, high_school_graduation_rate, 
         violent_crime_rate, housing_problems)

health_2 <- read_excel("raw_data/health_cont.xlsx", 
                                  skip = 1) %>%
  clean_names() %>%
  rename("physical_distress" = percent_frequent_physical_distress,
         "mental_distress" = percent_frequent_mental_distress) %>%
  drop_na(county) %>%
  transform(district = paste(county, state, sep = ", ")) %>%
  select(district, physical_distress, mental_distress, life_expectancy, 
         segregation_index, segregation_index_2, percent_homeowners, 
         percent_black, percent_non_hispanic_white, percent_hispanic, 
         homicide_rate, firearm_fatalities_rate)

health <- inner_join(health_1, health_2, by = "district") %>%
  mutate(district = tolower(district))
```

Parameter dataset

```{r}
model <- left_join(health, police_killings, by = "district") %>%
  left_join(model_violence, by = "district") %>%
  left_join(census_data, by = "district") %>%
  mutate(percent_black_hispanic = percent_black + percent_hispanic,
         number_protests = ifelse(is.na(number_protests), yes = 0, 
                                  no = model$number_protests),
         number_violent = ifelse(is.na(number_violent), yes = 0, 
                                 no = model$number_violent),
         police_killings = ifelse(is.na(police_killings), yes = 0, 
                                  no = model$police_killings),
         teen_birth_rate = teen_birth_rate / 10)
```

Modeling: all
```{r}
fit_all <- stan_glm(data = model,
                    formula = number_violent ~ teen_birth_rate + housing_problems + 
                      physical_distress + mental_distress + segregation_index_2 + 
                      police_killings + gini_score + number_protests + 
                      poverty + percent_black_hispanic, 
                    refresh = 0)

new_obs <- tibble(number_protests = 7,
                                  gini_score = 0.9,
                                  poverty = 80,
                                  housing_problems = 13.87,
                                  physical_distress = 12.13,
                                  mental_distress = 12.99,
                                  segregation_index_2 = 30.81,
                                  police_killings = 2.7,
                                  percent_black_hispanic = 18.67,
                                  teen_birth_rate = 2.98)

new_obs_default <- tibble(number_protests = 4.89,
                  gini_score = 0.45,
                  poverty = 12.41,
                  housing_problems = 13.87,
                  physical_distress = 12.13,
                  mental_distress = 12.99,
                  segregation_index_2 = 30.81,
                  police_killings = 2.7,
                  percent_black_hispanic = 18.67,
                  teen_birth_rate = 2.98)

default <- posterior_predict(fit_all, newdata = new_obs_default) %>%
  as_tibble() %>%
  mutate_all(as.numeric) %>%
  rename("default" = `1`)

new <- posterior_predict(fit_all, newdata = new_obs) %>%
  as_tibble() %>%
  mutate_all(as.numeric) %>%
  rename("new" = `1`)

full <- default %>%
  bind_cols(new) %>%
  pivot_longer(cols = default:new,
               names_to = "pp_results",
               values_to = "number_violent")

full %>%
  ggplot(aes(x = number_violent, fill = pp_results)) +
    geom_histogram(aes(y = after_stat(count/sum(count))), bins = 75,
                           color = "white", position = "identity", alpha = 0.6) +
    scale_y_continuous(labels = scales::percent_format()) + 
    xlim(c(-10,20)) +
    labs(x = "Number of Violent Protests",
         y = "Probability",
         title = "Model: Number of Violent Protests \n in a Hypothetical County") +
    theme_economist() + 
    theme(title = element_text(size = 10), 
          legend.text = element_text(size = 10),
          axis.text.y = element_text(size = 8),
          axis.text.x = element_text(size = 8),
          axis.title.x = element_text(size = 10, face = "bold"),
          axis.title.y = element_text(size = 10, face = "bold")) +
    scale_fill_manual(name = "", 
                      breaks = c("default", "new"),
                      labels = c("Average County", "Hypothetical County"),
                      values = c("#00798c", "#d1495b"))
```


Modeling: Income Inequality
```{r}
model_violence_gini <- model_violence %>%
  left_join(gini_final, by = "district") %>%
  select(district, violence, gini_score, proportion_violent)

fit_obj_gini <- stan_glm(data = model_violence_gini,
                    proportion_violent ~ gini_score - 1,
                    refresh = 0)

new_obs_gini <- tibble(gini_score = c(0.3288, 0.4238, 0.4489, 0.6592))

pp_gini <- posterior_predict(fit_obj_gini, newdata = new_obs_gini) %>%
  as_tibble() %>%
  mutate_all(as.numeric) %>%
  rename("min" = `1`,
         "low" = `2`,
         "high" = `3`,
         "max" = `4`) %>%
  pivot_longer(cols = min:max,
               names_to = "gini",
               values_to = "proportion_violent")

pp_gini_mean <- pp_gini %>%
  group_by(gini) %>%
  summarize(mean_violence = mean(proportion_violent), .groups = "drop") %>%
  arrange(mean_violence)

pp_gini_mean$mean_violence

ggplot(pp_gini, aes(x = proportion_violent, fill = gini)) +
  geom_histogram(aes(y = after_stat(count/sum(count))), bins = 75,
                 color = "white", position = "identity", alpha = 0.5) +
  geom_vline(xintercept = pp_gini_mean$mean_violence[1]) +
  geom_vline(xintercept = pp_gini_mean$mean_violence[2]) +
  geom_vline(xintercept = pp_gini_mean$mean_violence[3]) +
  geom_vline(xintercept = pp_gini_mean$mean_violence[4]) +
  scale_y_continuous(labels = scales::percent_format()) + 
  labs(title = "Posterior Distribution for Violence based on Gini",
       x = "Proportion Violent",
       y = "Probability") +
  theme_bw()

```

Modeling: Poverty
```{r}
model_violence_poverty <- model_violence %>%
  left_join(poverty_final, by = "district") %>%
  select(district, violence, poverty, proportion_violent) %>%
  drop_na(poverty)

fit_obj_poverty <- stan_glm(data = model_violence_poverty,
                    proportion_violent ~ poverty - 1,
                    refresh = 0)

quantile(model_violence_poverty$poverty)

new_obs_poverty <- tibble(poverty = c(8.7, 15.5))

pp_poverty <- posterior_predict(fit_obj_poverty, newdata = new_obs_poverty) %>%
  as_tibble() %>%
  mutate_all(as.numeric) %>%
  rename("low" = `1`,
         "high" = `2`) %>%
  pivot_longer(cols = low:high,
               names_to = "poverty",
               values_to = "proportion_violent")

ggplot(pp_poverty, aes(x = proportion_violent, fill = poverty)) +
  geom_histogram(aes(y = after_stat(count/sum(count))), bins = 75,
                 color = "white", position = "identity", alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) + 
  labs(title = "Posterior Distribution for Poverty Rate",
       x = "Poverty Rate",
       y = "Probability") +
  theme_bw()

```

Modeling: Income
```{r}
model_violence_income <- model_violence %>%
  left_join(income_final, by = "district") %>%
  select(district, violence, income, proportion_violent) %>%
  drop_na(income)

fit_obj_income <- stan_glm(data = model_violence_income,
                    proportion_violent ~ income - 1,
                    refresh = 0)

new_obs_income <- tibble(income = c(53518, 72736))

pp_income <- posterior_predict(fit_obj_income, newdata = new_obs_income) %>%
  as_tibble() %>%
  mutate_all(as.numeric) %>%
  rename("low" = `1`,
         "high" = `2`) %>%
  pivot_longer(cols = low:high,
               names_to = "income",
               values_to = "proportion_violent")

ggplot(pp_income, aes(x = proportion_violent, fill = income)) +
  geom_histogram(aes(y = after_stat(count/sum(count))), bins = 75,
                 color = "white", position = "identity", alpha = 0.5) +
  scale_y_continuous(labels = scales::percent_format()) + 
  labs(title = "Posterior Distribution for Violence based on Income",
       x = "Proportion Violent",
       y = "Probability") +
  theme_bw()

```
General Protest Info
```{r}
protesters_type <- levels(acled_data$assoc_actor_1)
event_type <- levels(acled_data$event_type)
sub_event_type <- levels(acled_data$sub_event_type)

blm_terms <- c("BLM", "NAACP", "African American", "African", "Black")
labor_terms <- c("Federation", "Union", "Labor", "Labour", "Worker", "AFL")
antifa_terms <- c("Antifa", "antifa", "Anti Facist")
militia_terms <- c("Militia", "Patriot", "Proud Boy", "Boogaloo", "KKK", 
                   "QAnon")
pro_police_terms <- c("Pro-Police", "Pro Police", "Blue")
republican_terms <- c("Republican", "GOP")
democrat_terms <- c("Dem", "Democrat")

acled_w_subjects <- acled_data_new %>%
  mutate(blm = ifelse(str_detect(assoc_actor_1, 
                                 paste(blm_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(labor = ifelse(str_detect(assoc_actor_1, 
                                   paste(labor_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(antifa = ifelse(str_detect(assoc_actor_1, 
                                   paste(antifa_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(militia = ifelse(str_detect(assoc_actor_1, 
                                   paste(militia_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(pro_police = ifelse(str_detect(assoc_actor_1, 
                                   paste(pro_police_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(republican = ifelse(str_detect(assoc_actor_1, 
                                   paste(republican_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(democrat = ifelse(str_detect(assoc_actor_1, 
                                   paste(democrat_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(unknown = ifelse(is.na(assoc_actor_1), yes = TRUE, no = FALSE)) %>%
  mutate(all_actors = TRUE,
         all_violence = TRUE) %>%
  pivot_longer(cols = blm:democrat,
               names_to = "subject",
               values_to = "group_boolean")

acled_w_subjects %>%
  filter(sub_event_type %in% c("Peaceful protest", "Protest with intervention",
                                             "Violent demonstration", "Mob violence")) %>%
  filter(subject == "blm" & group_boolean == TRUE) %>%
  select(sub_event_type) %>%
  group_by(sub_event_type) %>%
  summarize(count = n(), .groups = "drop") %>%
  ggplot(aes(x = factor(sub_event_type, levels = c("Mob violence",
                                                   "Violent demonstration",
                                                   "Protest with intervention",
                                                   "Peaceful protest")), 
                           y = count)) + 
                geom_col(fill = "#d1495b", color = "white", alpha = 0.7) + 
                labs(title = "Violence during Protests",
                     subtitle = "Summer and Fall 2020",
                     x = "Type of Protest",
                     y = "Number of Protests") +
                scale_x_discrete(drop = FALSE, breaks = c("Mob violence",
                                                   "Violent demonstration",
                                                   "Protest with intervention",
                                                   "Peaceful protest"),
                                 labels = c("Mob \n violence",
                                                   "Violent \n demonstration",
                                                   "Protest with \n intervention",
                                                   "Peaceful \n protest")) + 
                theme_economist() + 
                coord_flip() + 
                theme(axis.text.y = element_text(size = 8, hjust = 1),
                      axis.text.x = element_text(size = 8),
                      axis.title.x = element_text(size = 12, face = "bold",
                                                  vjust = -1),
                      axis.title.y = element_text(size = 12, face = "bold",
                                                  vjust = 4))


```

Mapping
```{r}
census_api_key("c272499f01a005c075c74055db3526e316e1836d")

rural <- get_decennial(geography = "state",
                       variables = c("P001001", "P002005"),
                       year = 2010,
                       output = "wide",
                       geometry = TRUE) %>%
  rename(state = NAME) %>%
  mutate(prop_rural = P002005/P001001,
         state = reorder(state, prop_rural))

subset <- acled_data_new %>%
  mutate(event_date = ymd(event_date)) %>%
  filter(event_date <= "2020-06-01")

pal <- 
   colorFactor(palette = "Spectral",
               levels = c("Peaceful protest", "Protest with intervention", 
                          "Violent demonstration", "Mob violence"))

leaflet(rural) %>%
  addTiles() %>%
  addCircleMarkers(lng = subset$longitude, lat = subset$latitude, radius = 0.1,
                   color = ~pal(acled_data_new$sub_event_type))
```






from meeting w Mitchell â€” what we'll end up doing is basically this

```{r}
new_obssss <- tibble(gini_score = input$whatever,
                  poverty = input$whatever)

posterior_predict(dataset, new_obssss)
```

interesting final projects:
https://nidal-morrison.shinyapps.io/urgent_fury/
https://wyatthurt.shinyapps.io/water_conflict/
