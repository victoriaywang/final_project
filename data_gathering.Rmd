---
title: "Data Gathering"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(janitor)
library(tidycensus)
library(leaflet)
library(lubridate)
library(stringr)
library(rstanarm)
```

Dataset
```{r}
acled_data <- read_xlsx("raw_data/USA_2020_Oct31_new.xlsx") %>%
  clean_names() %>%
  mutate(assoc_actor_1 = as.factor(assoc_actor_1),
         event_type = as.factor(event_type),
         sub_event_type = as.factor(sub_event_type)) %>%
  filter(!event_type == "Strategic developments") %>%
  mutate(event_date = ymd(event_date))
```

Violence -- BLM vs All Protests
```{r}
violence <- acled_data %>%
  select(sub_event_type) %>%
  mutate(sub_event_type = as.factor(sub_event_type)) %>%
  filter(sub_event_type == c("Peaceful protest", "Protest with intervention",
                            "Excessive force against protesters",
                            "Violent demonstration",
                            "Mob violence")) %>%
  group_by(sub_event_type) %>%
  summarize(count = n())

violence_BLM <- acled_data %>%
  filter(assoc_actor_1 == "BLM: Black Lives Matter") %>%
  select(sub_event_type) %>%
  mutate(sub_event_type = as.factor(sub_event_type)) %>%
  filter(sub_event_type == c("Peaceful protest", "Protest with intervention",
                            "Excessive force against protesters",
                            "Violent demonstration",
                            "Mob violence")) %>%
  group_by(sub_event_type) %>%
  summarize(count = n(), .groups = "drop")

comparison <- inner_join(violence, violence_BLM, by = "sub_event_type") %>%
  rename(all = count.x,
         blm = count.y) %>%
  pivot_longer(cols = all:blm,
               names_to = "type",
               values_to = "count")

ggplot(comparison, aes(x = reorder(sub_event_type, count), 
                       y = count, fill = type)) +
    geom_col(position = "identity") + 
    labs(title = "Violence at Protests",
         subtitle = "Summer and Fall 2020",
         x = "Type of Protest",
         y = "Number of Protests") + 
    coord_flip() + 
    scale_color_manual(breaks = c("all", "blm"),
                       labels = c("All Protests", "BLM")) + 
    theme_classic()
  
```

General Protest Info
```{r}
protesters_type <- levels(acled_data$assoc_actor_1)
event_type <- levels(acled_data$event_type)
sub_event_type <- levels(acled_data$sub_event_type)

acled_data_new <- acled_data %>%
  select(-c(iso, event_id_cnty, event_id_no_cnty, year, time_precision, region, 
            country, admin3, geo_precision, source_scale, source)) %>%
  mutate(assoc_actor_1 = as.character(assoc_actor_1)) %>%
  mutate(blm = ifelse(str_detect(assoc_actor_1, 
                                 regex(c("BLM", "NAACP", "African American"), 
                                       ignore_case = TRUE)), 
                      yes = TRUE, no = FALSE)) %>%
  filter(blm == TRUE)


blm_terms <- c("BLM", "NAACP", "African American", "African", "Black")
labor_terms <- c("Federation", "Union", "Labor", "Labour", "Worker", "AFL")
antifa_terms <- c("Antifa", "antifa", "Anti Facist")
militia_terms <- c("Militia", "Patriot", "Proud Boy", "Boogaloo", "KKK", 
                   "QAnon")
pro_police_terms <- c("Pro-Police", "Pro Police", "Blue")
republican_terms <- c("Republican", "GOP")
democrat_terms <- c("Dem", "Democrat")


acled_data_new <- acled_data %>%
  select(-c(iso, event_id_cnty, event_id_no_cnty, year, time_precision, region, 
            country, admin3, geo_precision, source_scale, source)) %>%
  mutate(assoc_actor_1 = as.character(assoc_actor_1)) %>%
  mutate(blm = ifelse(str_detect(assoc_actor_1, 
                                 paste(blm_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(labor = ifelse(str_detect(assoc_actor_1, 
                                   paste(labor_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(antifa = ifelse(str_detect(assoc_actor_1, 
                                   paste(antifa_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(militia = ifelse(str_detect(assoc_actor_1, 
                                   paste(militia_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(pro_police = ifelse(str_detect(assoc_actor_1, 
                                   paste(pro_police_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(republican = ifelse(str_detect(assoc_actor_1, 
                                   paste(republican_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(democrat = ifelse(str_detect(assoc_actor_1, 
                                   paste(democrat_terms, collapse = '|')), 
                      yes = TRUE, no = FALSE)) %>%
  mutate(unknown = ifelse(is.na(assoc_actor_1), yes = TRUE, no = FALSE)) %>%
  mutate(all = TRUE) %>%
  rename("district" = admin2) %>%
  transform(district = paste(district, admin1, sep=", "))

```


Plotting Violence by Protest Subject
```{r}
violence_plot <- function(ps){
  acled_data_new %>%
  filter(sub_event_type %in% c("Peaceful protest", "Protest with intervention",
                               "Violent demonstration", "Mob violence")) %>%
  filter({{ps}} == TRUE) %>%
  select(sub_event_type, {{ps}}) %>%
  group_by(sub_event_type) %>%
  summarize(count = n(), .groups = "drop") %>%
  ggplot(aes(x = factor(sub_event_type, levels = c("Mob violence",
                                                   "Violent demonstration",
                                                   "Protest with intervention",
                                                   "Peaceful protest")), 
             y = count)) + 
    geom_col() + 
    labs(title = "Violence during Protests",
         subtitle = "Summer and Fall 2020",
         x = "Type of Protest",
         y = "Number of Protests") +
    scale_x_discrete(drop = FALSE) + 
    coord_flip() + 
    theme_classic()
}
violence_plot(blm)
```



Mapping
```{r}
census_api_key("c272499f01a005c075c74055db3526e316e1836d")

rural <- get_decennial(geography = "state",
                       variables = c("P001001", "P002005"),
                       year = 2010,
                       output = "wide",
                       geometry = TRUE) %>%
  rename(state = NAME) %>%
  mutate(prop_rural = P002005/P001001,
         state = reorder(state, prop_rural))

subset <- acled_data_new %>%
  mutate(event_date = ymd(event_date)) %>%
  filter(event_date <= "2020-06-01")

pal <- 
   colorFactor(palette = "Reds",
               levels = c("Peaceful protest", "Protest with intervention", 
                          "Violent demonstration", "Mob violence"))

#leaflet(rural) %>%
#  addTiles() %>%
#  addCircleMarkers(lng = subset$longitude, lat = subset$latitude, radius = 0.1,
#                   color = ~pal(acled_data_new$sub_event_type))

```

Modeling
```{r}
playing <- acled_data_new %>%
  filter(!sub_event_type == "Peaceful protest") %>%
  filter(unknown == TRUE)


gini <- read_csv("raw_data/census_gini.csv", col_types = cols(
  GEO_ID = col_character(),
  NAME = col_character(),
  B19083_001E = col_character(),
  B19083_001M = col_character()
))

gini_clean <- gini[-1 ,] %>%
  select(!c(B19083_001M, GEO_ID)) %>%
  rename("district" = NAME, 
         "gini_score" = B19083_001E) %>%
  mutate(gini_score = as.double(gini_score)) %>%
  separate(col = district, sep = ", ", into = c("district", "state")) 

gini_final <- gini_clean %>%
  mutate(district = sub(gini_clean$district, pattern = " [[:alpha:]]*$", 
                        replacement = "")) %>%
  select(district, gini_score, state) %>%
  transform(district = paste(district, state, sep=", "))
  
# Come back and fix the NA's. 

model <- left_join(x = acled_data_new, y = gini_final, by = "district") %>%
  filter(blm == TRUE) %>%
  drop_na(gini_score) %>%
  mutate(violence = ifelse(sub_event_type == "Peaceful protest", 
                           yes = FALSE, no = TRUE))

count_violent <- model %>%
  filter(violence == TRUE) %>%  
  group_by(district) %>%
  summarize(number_violent = n(), .groups = "drop")

count_protests <- model %>%
  group_by(district) %>%
  summarize(number_protests = n(), .groups = "drop")

model_cont <- full_join(count_violent, count_protests, by = "district")

model_cont[is.na(model_cont)] <- 0

model_cont2 <- model_cont %>%
  mutate(proportion_violent = number_violent / number_protests,
         violence = ifelse(proportion_violent == 0,
                                      yes = FALSE,
                                      no = TRUE)) %>%
  left_join(gini_final, by = "district") %>%
  select(district, violence, gini_score)

fit_obj <- stan_glm(data = model_cont2,
                    gini_score ~ violence - 1,
                    refresh = 0)

new_obs <- tibble(violence = c(TRUE, FALSE))

pp <- posterior_predict(fit_obj, newdata = new_obs) %>%
  as_tibble() %>%
  mutate_all(as.numeric) %>%
  rename("violent" = `1`,
         "not_violent" = `2`) %>%
  pivot_longer(cols = violent:not_violent,
               names_to = "violence",
               values_to = "gini_score")

ggplot(pp, aes(x = gini_score, fill = violence)) +
  geom_histogram() 

```

